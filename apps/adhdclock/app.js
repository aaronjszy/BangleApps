"use strict";function n(e,t,i,s,n){var r,a,d;n=(n-1)/2,r=i-e,a=s-t,d=Math.sqrt(r*r+a*a),r=Math.round(r*n/d),a=Math.round(a*n/d),g.fillPoly([e+r,t-a,e-r,t+a,i-r,s+a,i+r,s-a])}function r(e){return("0"+e.toString(10)).substr(-2,1e3)}class a{constructor(i,s){if(s){var n=s.split(":");let e="12"==n[0]?"0":n[0],t=(e=s.endsWith("pm",void 0)?r(parseInt(e,10)+12):r(parseInt(e,10)),n[1]);2<t.length&&(t=t.substr(0,2));s="-"+r((new Date).getTimezoneOffset()/60)+"00";this.date=new Date(`${i}T${e}:${t}:00 GMT`+s)}else this.date=i?new Date(i):new Date}floorMinutes(){this.date.setMinutes(0,0,0)}addMinutes(e){this.date=new Date(this.date.getTime()+6e4*e)}valueOf(){return this.date}formattedTime(){var e=this.date.getHours()%12;return(e=0==e?12:e)+":"+r(this.date.getMinutes())}formattedDate(){return require("locale").month(this.date,1)+" "+this.date.getDate()}formattedDateTime(){return this.formattedDate()+" "+this.formattedTime()}unixTimestampMillis(){return this.date.getTime()}millisUntil(){var e=new Date;return this.date.getTime()-e.getTime()}secondsUntil(){var e=new Date;return(this.date.getTime()-e.getTime())/1e3+1}minutesUntil(){var e=new Date;return(this.date.getTime()-e.getTime())/1e3/60+1}timeRemainingAsString(){var e=this.secondsUntil(),t=e<0?"-":"",e=Math.abs(e),e=Math.floor(e/60),i=Math.floor(e/60),e=e%60;return 0==i?t+e:t+i+":"+r(e)}secondsRemainingAsString(){var e=this.secondsUntil(),e=Math.abs(e);return""+r(Math.floor(e%60))}string(){return this.date.getFullYear()+"-"+r(this.date.getMonth()+1)+"-"+r(this.date.getDate())+" "+r(this.date.getHours())+":"+r(this.date.getMinutes())+":"+r(this.date.getSeconds())}equals(e){return this.date.getTime()==e.date.getTime()}}class t{constructor(e){this.tickHandler=e}scheduleNextMinuteTick(){setTimeout(()=>{this.tickHandler()},this.millisToNextMinute())}millisToNextMinute(){const e=new Date;return 6e4-(1e3*e.getSeconds()+e.getMilliseconds())}scheduleNextSecondTick(){setTimeout(()=>{this.tickHandler()},this.millisToNextSecond())}millisToNextSecond(){return 1e3-(new Date).getMilliseconds()}}var d,e,s,h,i,o,l,c;(e=d=d||{})[e.START=0]="START",e[e.END=1]="END";class m{constructor(e,t,i,s){this.name=e,this.description=t,this.startTime=i,this.endTime=s,this.skipped=!1,this.calendarEventId=void 0,this.trackedEventBoundary=d.END}static fromJSON(e){var t=new m(e.name,e.description,new a(e.startTime.date),new a(e.endTime.date));return t.skipped=e.skipped,t.calendarEventId=e.calendarEventId,t.trackedEventBoundary=e.trackedEventBoundary,t}update(e){if(e.calendarEventId!=this.calendarEventId)return!1;e.calendarEventId=this.calendarEventId,e.skipped=this.skipped,e.trackedEventBoundary=this.trackedEventBoundary;var t=JSON.stringify(e,void 0,void 0)!=JSON.stringify(this,void 0,void 0);return this.name=e.name,this.description=e.description,this.startTime=e.startTime,this.endTime=e.endTime,t}setBangleCalendarEventId(e){this.calendarEventId=e}toggleSkip(){return this.skipped=!this.skipped,this.skipped}toggleTrackedEventBoundary(){this.trackedEventBoundary=this.trackedEventBoundary==d.END?d.START:d.END}getTrackedEventBoundary(){return this.trackedEventBoundary}getTrackedEventDate(){return this.trackedEventBoundary==d.START?this.startTime:this.endTime}displayName(){return this.name.substr(0,14)}displayDescription(){return 0==this.description.length?"empty":50<this.displayDescription.length?this.description.substr(0,50)+"...":this.description}displayTimeRemaining(){return this.getTrackedEventDate().timeRemainingAsString()}displaySecondsRemaining(){return this.getTrackedEventDate().secondsRemainingAsString()}durationMinutes(){return(this.endTime.unixTimestampMillis()-this.startTime.unixTimestampMillis())/1e3/60}isExpired(){return!1}}class u{constructor(e){this.selectedEvent=0,this.events=e,this.refocusTimeout=void 0}save(){require("Storage").open("adhdclock.events","w").write(JSON.stringify(this,void 0,void 0))}restore(){var e=require("Storage").open("adhdclock.events","r");if(e){e=e.read(e.getLength());if(e){var t=JSON.parse(e);this.selectedEvent=t.selectedEvent,this.events=[];for(var i=0;i<t.events.length;i++)this.events[i]=m.fromJSON(t.events[i])}}return this}updateFromGBCalendar(e){let t={};for(var i=0;i<e.length;i++)this.addGBCalendarEvent(e[i])&&(t[e[i].id]=!0);this.events=this.events.filter(e=>e.calendarEventId&&t[e.calendarEventId]),this.dedup(),this.sort(),this.selectUpcomingEvent()}addGBCalendarEvent(e){var t=new Date,i=1e3*e.timestamp,s=1e3*(e.timestamp+e.durationInSeconds);return!(s>t.getTime()+864e5||s<t.getTime()-864e5)&&(!("calendar"!=e.t||!e.title||""==e.title||0!=e.type)&&(!e.allDay&&86400!=e.durationInSeconds&&((t=new m(e.title,e.description,new a(i),new a(s))).setBangleCalendarEventId(e.id),this.upsertEvent(t),!0)))}removeGBCalendarEvent(t){this.events=this.events.filter(e=>e.calendarEventId!=t.id)}sort(){this.events=this.events.sort((e,t)=>e.endTime.unixTimestampMillis()-t.endTime.unixTimestampMillis())}dedup(){for(var e=0;e<this.events.length;e++){var t=this.events[e];if(t)for(var i=e+1;i<this.events.length;i++){var s=this.events[i];s&&t.name==s.name&&t.startTime.date.getTime()==s.startTime.date.getTime()&&t.endTime.date.getTime()==s.endTime.date.getTime()&&(this.events.splice(i,1),i--)}}}upsertEvent(e){for(var t=0;t<this.events.length;t++){var i=this.events[t];if(i&&i.calendarEventId==e.calendarEventId)return i.update(e)}return this.events.push(e),!0}selectEvent(e){for(var t=0;t<this.events.length;t++)if(this.events[t]==e)return this.selectedEvent=t,this.getSelectedEvent();return this.getSelectedEvent()}selectUpcomingEvent(){return this.selectedEvent=this.getUpcomingEventIndex(),this.getSelectedEvent()}getUpcomingEventIndex(){for(var e=Number.MAX_VALUE,t=this.events.length-1,i=0;i<this.events.length;i++){var s,n=this.events[i];n&&(s=n.endTime.secondsUntil(),!n.skipped&&0<=s&&s<e&&(e=n.endTime.secondsUntil(),t=i))}return t}selectNextEvent(){return this.selectedEvent<this.events.length-1&&this.selectedEvent++,this.setRefocusTimeout(),this.getSelectedEvent()}selectPreviousEvent(){return 0<this.selectedEvent&&this.selectedEvent--,this.setRefocusTimeout(),this.getSelectedEvent()}getSelectedEvent(){return 0<this.events.length?this.events[this.selectedEvent]||new m("undefined","",new a,new a):new m("No events","",new a,new a)}setRefocusTimeout(){this.clearRefocusTimeout(),this.refocusTimeout=setTimeout(()=>{this.clearRefocusTimeout()},5e3)}clearRefocusTimeout(){this.refocusTimeout&&clearTimeout(this.refocusTimeout),this.refocusTimeout=void 0}}class v{constructor(e){this.eventsObj=e,this.clockInterval=new t(()=>{this.redrawAll()})}redrawAll(){this.clockInterval.scheduleNextMinuteTick(),g.reset(),g.clearRect({x:0,y:24,x2:g.getHeight(),y2:g.getWidth()});var e=new a,t=this.eventsObj.getSelectedEvent(),i=(g.reset(),g.setFontAlign(0,1),g.setFont("Vector",20),g.drawString(t.displayName(),88,72,!1),g.setFont("Vector",40),t.displayTimeRemaining()),i=(g.drawString(i,88,132,!1),e.formattedTime()),e=t.getTrackedEventDate().formattedTime(),s=t.startTime.formattedTime()+"/";s!=e&&t.getTrackedEventBoundary()!=d.START||(s=""),require("FontDennis8").add(Graphics),g.setFont("Dennis8",2),g.setFontAlign(-1,1),g.drawString(i,5,g.getHeight()-2,!0),g.setFontAlign(1,1),g.drawString(s+e,g.getWidth()-5,g.getHeight()-2,!0),new T(t).draw(),t.skipped&&(n(0,25,g.getWidth(),g.getHeight(),3),n(g.getWidth(),25,0,g.getHeight(),3))}}class T{constructor(e){this.minutesPerSegment=30,this.maxSegmentCount=10,this.eventStart=e.startTime.date,this.eventEnd=e.endTime.date,this.segmentCountInt=this.segmentCount(e),this.maxMinutesInMeter=this.segmentCountInt*this.minutesPerSegment,this.meterStartTime=new Date(e.getTrackedEventDate().date.getTime()+6e4*-this.maxMinutesInMeter),this.meterEndTime=e.getTrackedEventDate().date,this.padding=5,this.height=22,this.meterTopOffsetPos=.73*g.getHeight(),this.maxMeterWidth=g.getWidth()-2*this.padding}segmentCount(e){var t=e.durationMinutes(),t=Math.ceil(t/this.minutesPerSegment),e=(t>this.maxSegmentCount&&(t=this.maxSegmentCount),Math.ceil(e.getTrackedEventDate().minutesUntil()/this.minutesPerSegment));return(e=e<=1?1:e)>this.maxSegmentCount&&(e=this.maxSegmentCount),Math.max(t,e)}draw(){for(var e,t=g.getColor(),i=(g.setColor("#00FF00"),this.drawMeterFill(this.meterStartTime,this.meterEndTime),g.setColor("#2c007d"),this.drawMeterFill(this.eventStart,this.eventEnd),g.setColor("#FF0000"),this.drawMeterFill(this.meterStartTime,new Date),this.meterStartTime.getTime()<this.eventStart.getTime()&&this.eventStart.getTime()<this.meterEndTime.getTime()&&(g.setColor("#00FF00"),e=this.dateToXPos(this.eventStart),g.fillPoly([e,this.meterTopOffsetPos,e,this.meterTopOffsetPos+this.height,e+this.height/2,this.meterTopOffsetPos+this.height/2]),g.drawLine(e,this.meterTopOffsetPos,e,this.meterTopOffsetPos+this.height)),g.setColor("#000000"),g.drawRect({x:this.padding,y:this.meterTopOffsetPos,h:this.height,w:this.maxMeterWidth}),g.drawRect({x:this.padding+1,y:this.meterTopOffsetPos+1,h:this.height-2,w:this.maxMeterWidth-2}),this.maxMeterWidth/this.segmentCountInt),s=1;s<=this.segmentCountInt;s++){var n=this.padding+i*s;g.drawLine(n,this.meterTopOffsetPos,n,this.meterTopOffsetPos+this.height),g.drawLine(n-1,this.meterTopOffsetPos,n-1,this.meterTopOffsetPos+this.height)}g.setColor(t)}drawMeterFill(e,t){e=this.dateToXPos(e),t=this.dateToXPos(t);e!=t&&g.fillRect(e,this.meterTopOffsetPos,t,this.meterTopOffsetPos+this.height)}dateToXPos(e){e=(e.getTime()-this.meterStartTime.getTime())/1e3/60/this.maxMinutesInMeter;return 1<(e=e<0?0:e)&&(e=1),(g.getWidth()-2*this.padding)*e+this.padding}}class p{constructor(e,t){this.clockFace=e,this.events=t}userForceCalendarUpdateEvent(){(NRF.getSecurityStatus().connected?(this.forceCalendarSync(),E.showAlert("Request sent to the phone")):E.showAlert("You are not connected")).then(()=>{this.clockFace.redrawAll()})}forceCalendarSync(){var e;NRF.getSecurityStatus().connected&&((e=require("Storage").readJSON("android.calendar.json",!0))&&Array.isArray(e)||(e=[]),this.gbSend({t:"force_calendar_sync",ids:e.map(e=>e.id)}))}gbSend(e){e=JSON.stringify(e,void 0,void 0);Bluetooth.println(""),Bluetooth.println(e)}readCalendarDataAndUpdate(){this.forceCalendarSync();var e=require("Storage").readJSON("android.calendar.json",!0);e?(this.events.updateFromGBCalendar(e),this.clockFace.redrawAll()):E.showAlert("No calendar data found.").then(()=>{E.showAlert().then(()=>{this.clockFace.redrawAll()})})}}l=new u([]).restore(),c=new v(l),setTimeout(function(){new p(c,l).readCalendarDataAndUpdate()},10),l.selectUpcomingEvent(),Bangle.setUI("clock"),Bangle.loadWidgets(),Bangle.drawWidgets(),c.redrawAll(),s=c,h=l,i=global.GB,global.GB=function(e){switch(e.t){case"calendar":e.id,e.title,new a(1e3*e.timestamp).string(),h.addGBCalendarEvent(e);break;case"calendar-":e.id,h.removeGBCalendarEvent(e);break;case"calendarevents":JSON.stringify(e.events,void 0,void 0)}i&&i(e)},setWatch(()=>{h.save(),Bangle.showLauncher()},BTN1,{repeat:!1,edge:"falling"}),Bangle.on("swipe",function(e,t){var i;-1==e&&0==t&&(h.selectNextEvent(),s.redrawAll()),1==e&&0==t&&(h.selectPreviousEvent(),s.redrawAll()),-1==t&&0==e&&(i=h.getSelectedEvent().toggleSkip(),s.redrawAll(),i&&setTimeout(()=>{h.selectUpcomingEvent(),s.redrawAll()},200)),1==t&&0==e&&new p(s,h).userForceCalendarUpdateEvent()}),o=!1,Bangle.on("touch",function(e,t){!t||o||(t.y>g.getHeight()-50?(h.getSelectedEvent().toggleTrackedEventBoundary(),s.redrawAll()):50<t.y&&(o=!0,setTimeout(()=>{E.showPrompt(h.getSelectedEvent().displayDescription(),{buttons:{Ok:1}}).then(()=>{o=!1,s.redrawAll()})},200)))});