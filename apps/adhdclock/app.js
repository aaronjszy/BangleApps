"use strict";function s(e,t,i,n,s){var r,a,d;s=(s-1)/2,r=i-e,a=n-t,d=Math.sqrt(r*r+a*a),r=Math.round(r*s/d),a=Math.round(a*s/d),g.fillPoly([e+r,t-a,e-r,t+a,i-r,n+a,i+r,n-a])}function r(e){return("0"+e.toString(10)).substr(-2,1e3)}class d{constructor(i,n){if(n){var s=n.split(":");let e="12"==s[0]?"0":s[0],t=(e=n.endsWith("pm",void 0)?r(parseInt(e,10)+12):r(parseInt(e,10)),s[1]);2<t.length&&(t=t.substr(0,2));n="-"+r((new Date).getTimezoneOffset()/60)+"00";this.date=new Date(`${i}T${e}:${t}:00 GMT`+n)}else this.date=i?new Date(i):new Date}floorMinutes(){this.date.setMinutes(0,0,0)}addMinutes(e){this.date=new Date(this.date.getTime()+6e4*e)}valueOf(){return this.date}formattedTime(){var e=this.date.getHours()%12;return(e=0==e?12:e)+":"+r(this.date.getMinutes())}formattedDate(){return require("locale").month(this.date,1)+" "+this.date.getDate()}formattedDateTime(){return this.formattedDate()+" "+this.formattedTime()}unixTimestampMillis(){return this.date.getTime()}millisUntil(){var e=new Date;return this.date.getTime()-e.getTime()}secondsUntil(){var e=new Date;return(this.date.getTime()-e.getTime())/1e3+1}minutesUntil(){var e=new Date;return(this.date.getTime()-e.getTime())/1e3/60+1}timeRemainingAsString(){var e=this.secondsUntil(),t=e<0?"-":"",e=Math.abs(e),e=Math.floor(e/60),i=Math.floor(e/60),e=e%60;return 0==i?t+e:t+i+":"+r(e)}secondsRemainingAsString(){var e=this.secondsUntil(),e=Math.abs(e);return""+r(Math.floor(e%60))}equals(e){return this.date.getTime()==e.date.getTime()}}var a;(u=a=a||{})[u.START=0]="START",u[u.END=1]="END";class o{constructor(e,t,i,n){this.alarmHandler=()=>{},this.id=e+"/"+(new Date).getTime().toString(10),this.name=e,this.description=t,this.startTime=i,this.endTime=n,this.skipped=!1,this.bangleCalendarEventId=void 0,this.trackedEventBoundary=a.END}static fromJSON(e){var t=new o(e.name,e.description,new d(e.startTime.date),new d(e.endTime.date));return t.id=e.id,t.skipped=e.skipped,t.bangleCalendarEventId=e.bangleCalendarEventId,t.trackedEventBoundary=e.trackedEventBoundary,t}setAlarmHandler(e){this.alarmHandler=e}update(e){if(e.bangleCalendarEventId!=this.bangleCalendarEventId)return!1;e.id=this.id,e.bangleCalendarEventId=this.bangleCalendarEventId,e.skipped=this.skipped,e.trackedEventBoundary=this.trackedEventBoundary,e.alarmHandler=this.alarmHandler;var t=JSON.stringify(e,void 0,void 0)!=JSON.stringify(this,void 0,void 0);return this.name=e.name,this.description=e.description,this.startTime=e.startTime,this.endTime=e.endTime,t}setBangleCalendarEventId(e){this.bangleCalendarEventId=e}toggleSkip(){return this.skipped=!this.skipped,this.skipped}toggleTrackedEventBoundary(){this.trackedEventBoundary=this.trackedEventBoundary==a.END?a.START:a.END}getTrackedEventBoundary(){return this.trackedEventBoundary}getTrackedEventDate(){return this.trackedEventBoundary==a.START?this.startTime:this.endTime}displayName(){return this.name.substr(0,14)}displayDescription(){return 0==this.description.length?"empty":50<this.displayDescription.length?this.description.substr(0,50)+"...":this.description}displayTimeRemaining(){return this.getTrackedEventDate().timeRemainingAsString()}displaySecondsRemaining(){return this.getTrackedEventDate().secondsRemainingAsString()}durationMinutes(){return(this.endTime.unixTimestampMillis()-this.startTime.unixTimestampMillis())/1e3/60}isExpired(){return!1}}class h{constructor(e){this.minutesPerSegment=30,this.maxSegmentCount=10,this.eventStart=e.startTime.date,this.eventEnd=e.endTime.date,this.segmentCountInt=this.segmentCount(e),this.maxMinutesInMeter=this.segmentCountInt*this.minutesPerSegment,this.meterStartTime=new Date(e.getTrackedEventDate().date.getTime()+6e4*-this.maxMinutesInMeter),this.meterEndTime=e.getTrackedEventDate().date,this.padding=5,this.height=22,this.meterTopOffsetPos=.73*g.getHeight(),this.maxMeterWidth=g.getWidth()-2*this.padding}segmentCount(e){var t=e.durationMinutes(),t=Math.ceil(t/this.minutesPerSegment),e=(t>this.maxSegmentCount&&(t=this.maxSegmentCount),Math.ceil(e.getTrackedEventDate().minutesUntil()/this.minutesPerSegment));return(e=e<=1?1:e)>this.maxSegmentCount&&(e=this.maxSegmentCount),Math.max(t,e)}draw(){for(var e,t=g.getColor(),i=(g.setColor("#00FF00"),this.drawMeterFill(this.meterStartTime,this.meterEndTime),g.setColor("#2c007d"),this.drawMeterFill(this.eventStart,this.eventEnd),g.setColor("#FF0000"),this.drawMeterFill(this.meterStartTime,new Date),this.meterStartTime.getTime()<this.eventStart.getTime()&&this.eventStart.getTime()<this.meterEndTime.getTime()&&(g.setColor("#00FF00"),e=this.dateToXPos(this.eventStart),g.fillPoly([e,this.meterTopOffsetPos,e,this.meterTopOffsetPos+this.height,e+this.height/2,this.meterTopOffsetPos+this.height/2]),g.drawLine(e,this.meterTopOffsetPos,e,this.meterTopOffsetPos+this.height)),g.setColor("#000000"),g.drawRect({x:this.padding,y:this.meterTopOffsetPos,h:this.height,w:this.maxMeterWidth}),g.drawRect({x:this.padding+1,y:this.meterTopOffsetPos+1,h:this.height-2,w:this.maxMeterWidth-2}),this.maxMeterWidth/this.segmentCountInt),n=1;n<=this.segmentCountInt;n++){var s=this.padding+i*n;g.drawLine(s,this.meterTopOffsetPos,s,this.meterTopOffsetPos+this.height),g.drawLine(s-1,this.meterTopOffsetPos,s-1,this.meterTopOffsetPos+this.height)}g.setColor(t)}drawMeterFill(e,t){e=this.dateToXPos(e),t=this.dateToXPos(t);e!=t&&g.fillRect(e,this.meterTopOffsetPos,t,this.meterTopOffsetPos+this.height)}dateToXPos(e){e=(e.getTime()-this.meterStartTime.getTime())/1e3/60/this.maxMinutesInMeter;return 1<(e=e<0?0:e)&&(e=1),(g.getWidth()-2*this.padding)*e+this.padding}}class n{constructor(e,t){this.clockFace=e,this.events=t}forceCalendarUpdate(){(NRF.getSecurityStatus().connected?(this.gbSend(JSON.stringify({t:"force_calendar_sync",ids:[]},void 0,void 0)),E.showAlert("Request sent to the phone")):E.showAlert("You are not connected")).then(()=>{this.clockFace.redrawAll()})}gbSend(e){Bluetooth.println(""),Bluetooth.println(JSON.stringify(e,void 0,void 0))}readCalendarDataAndUpdate(){this.events.removeExpiredEvents();var e=require("Storage").readJSON("android.calendar.json",!0);(e?(e=this.events.updateFromCalendar(e),E.showAlert("Got calendar data. Updated "+e+".")):E.showAlert("No calendar data found.")).then(()=>{E.showAlert().then(()=>{this.clockFace.redrawAll()})})}}console.log(new Date,"0"),require("Font7x11Numeric7Seg").add(Graphics);var l,t,m,i,e=new class{constructor(e){this.selectedEvent=0,this.events=e,this.refocusTimeout=void 0}save(){require("Storage").open("adhdclock.events","w").write(JSON.stringify(this,void 0,void 0))}restore(){var e=require("Storage").open("adhdclock.events","r");if(e){e=e.read(e.getLength());if(e){var t=JSON.parse(e);this.selectedEvent=t.selectedEvent,this.events=[];for(var i=0;i<t.events.length;i++)this.events[i]=o.fromJSON(t.events[i])}}return this}removeExpiredEvents(){var t=(new Date).getTime()-432e5;this.events=this.events.filter(e=>e.endTime.unixTimestampMillis()>t)}updateFromCalendar(e){for(var t=0,i=new Date,n=0;n<e.length;n++){var s=e[n],r=1e3*s.timestamp,a=1e3*(s.timestamp+s.durationInSeconds);a>i.getTime()+864e5||a<i.getTime()-864e5||s.title&&""!=s.title&&"calendar"==s.t&&!s.allDay&&86400!=s.durationInSeconds&&0==s.type&&((r=new o(s.title,s.description,new d(r),new d(a))).setBangleCalendarEventId(s.id),this.addEvent(r)&&t++)}return this.dedupEvents(),this.sortEvents(),this.selectUpcomingEvent(),t}addEvent(e){for(var t=0;t<this.events.length;t++){var i=this.events[t];if(i&&i.bangleCalendarEventId==e.bangleCalendarEventId)return i.update(e)}return this.events.push(e),!0}sortEvents(){this.events=this.events.sort((e,t)=>e.endTime.unixTimestampMillis()-t.endTime.unixTimestampMillis())}dedupEvents(){for(var e=0;e<this.events.length;e++){var t=this.events[e];if(t)for(var i=e+1;i<this.events.length;i++){var n=this.events[i];n&&t.name==n.name&&t.startTime.date.getTime()==n.startTime.date.getTime()&&t.endTime.date.getTime()==n.endTime.date.getTime()&&(this.events.splice(i,1),i--)}}}selectEvent(e){for(var t=0;t<this.events.length;t++)if(this.events[t]==e)return this.selectedEvent=t,this.getSelectedEvent();return this.getSelectedEvent()}getUpcomingEventIndex(){for(var e=Number.MAX_VALUE,t=this.events.length-1,i=0;i<this.events.length;i++){var n,s=this.events[i];s&&(n=s.endTime.secondsUntil(),!s.skipped&&0<=n&&n<e&&(e=s.endTime.secondsUntil(),t=i))}return t}selectUpcomingEvent(){return this.selectedEvent=this.getUpcomingEventIndex(),this.getSelectedEvent()}selectNextEvent(){return this.selectedEvent<this.events.length-1&&this.selectedEvent++,this.setRefocusTimeout(),this.getSelectedEvent()}selectPreviousEvent(){return 0<this.selectedEvent&&this.selectedEvent--,this.setRefocusTimeout(),this.getSelectedEvent()}getSelectedEvent(){return 0<this.events.length?this.events[this.selectedEvent]||new o("undefined","",new d,new d):new o("No events","",new d,new d)}setRefocusTimeout(){this.clearRefocusTimeout(),this.refocusTimeout=setTimeout(()=>{this.clearRefocusTimeout()},5e3)}clearRefocusTimeout(){this.refocusTimeout&&clearTimeout(this.refocusTimeout),this.refocusTimeout=void 0}hasEvents(){return 0<this.events.length}}([]).restore(),c=(console.log(new Date,"1"),new class{constructor(e){this.eventsObj=e}redrawAll(){g.reset(),g.clearRect({x:0,y:24,x2:g.getHeight(),y2:g.getWidth()}),this.draw()}draw(){var e=new d,t=this.eventsObj.getSelectedEvent(),i=(g.reset(),g.setFontAlign(0,1),g.setFont("Vector",20),g.drawString(t.displayName(),88,72,!1),g.setFont("Vector",40),t.displayTimeRemaining()),i=(g.drawString(i,88,132,!1),e.formattedTime()),e=t.getTrackedEventDate().formattedTime(),n=t.startTime.formattedTime()+"/";n!=e&&t.getTrackedEventBoundary()!=a.START||(n=""),require("FontDennis8").add(Graphics),g.setFont("Dennis8",2),g.setFontAlign(-1,1),g.drawString(i,5,g.getHeight()-2,!0),g.setFontAlign(1,1),g.drawString(n+e,g.getWidth()-5,g.getHeight()-2,!0),new h(t).draw(),t.skipped&&(s(0,25,g.getWidth(),g.getHeight(),3),s(g.getWidth(),25,0,g.getHeight(),3))}}(e)),u=new d,u=(u.addMinutes(60),u.floorMinutes(),setTimeout(function(){new n(c,e).readCalendarDataAndUpdate()},10),console.log(new Date,"a"),e.hasEvents()||e.addEvent(new o("next hour","",u,u)),e.selectUpcomingEvent(),console.log(new Date,"b"),Bangle.setUI("clock"),Bangle.loadWidgets(),console.log(new Date,"c"),Bangle.drawWidgets(),console.log(new Date,"d"),c.redrawAll(),console.log(new Date,"e"),new class{constructor(){this.tickHandler=()=>{},this.minuteIntervalEnabled=!1,this.secondIntervalEnabled=!1}setTickHandler(e){this.tickHandler=e}enableMinuteInterval(){this.minuteIntervalEnabled=!0,this.minuteTimeout||this.scheduleNextMinuteTick()}disableMinuteInterval(){this.minuteTimeout&&clearInterval(this.minuteTimeout),this.minuteTimeout=void 0,this.minuteIntervalEnabled=!1}scheduleNextMinuteTick(){this.minuteTimeout=setTimeout(()=>{this.tick()},this.millisToNextMinute())}millisToNextMinute(){const e=new Date;return 6e4-(1e3*e.getSeconds()+e.getMilliseconds())}tick(){this.minuteIntervalEnabled?(this.scheduleNextMinuteTick(),this.tickHandler(this)):this.secondIntervalEnabled&&(this.scheduleNextSecondTick(),this.tickHandler(this))}isSecondIntervalEnabled(){return this.secondIntervalEnabled}enableSecondInterval(){this.secondIntervalEnabled=!0,this.secondTimeout||this.scheduleNextSecondTick()}disableSecondInterval(){this.secondTimeout&&clearInterval(this.secondTimeout),this.secondTimeout=void 0,this.secondIntervalEnabled=!1}scheduleNextSecondTick(){this.secondTimeout=setTimeout(()=>{this.tick()},this.millisToNextSecond())}millisToNextSecond(){return 1e3-(new Date).getMilliseconds()}useSecondInterval(){this.secondIntervalEnabled||(this.disableMinuteInterval(),this.enableSecondInterval())}useMinuteInterval(){this.minuteIntervalEnabled||(this.disableSecondInterval(),this.enableMinuteInterval())}toggleBetweenSecondAndMinuteIntervals(){this.minuteIntervalEnabled?this.useSecondInterval():this.useMinuteInterval()}});u.setTickHandler(()=>{c.redrawAll()}),u.useMinuteInterval(),l=c,t=u,m=e,setWatch(()=>{m.save(),Bangle.showLauncher()},BTN1,{repeat:!1,edge:"falling"}),Bangle.on("swipe",function(e,t){var i;-1==e&&0==t&&(m.selectNextEvent(),l.redrawAll()),1==e&&0==t&&(m.selectPreviousEvent(),l.redrawAll()),-1==t&&0==e&&(i=m.getSelectedEvent().toggleSkip(),l.redrawAll(),i&&setTimeout(()=>{m.selectUpcomingEvent(),l.redrawAll()},200)),1==t&&0==e&&new n(l,m).forceCalendarUpdate()}),i=!1,Bangle.on("touch",function(e,t){!t||i||(t.y>g.getHeight()-50?(m.getSelectedEvent().toggleTrackedEventBoundary(),l.redrawAll()):50<t.y&&(i=!0,setTimeout(()=>{E.showPrompt(m.getSelectedEvent().displayDescription(),{buttons:{Ok:1}}).then(()=>{i=!1,l.redrawAll()})},200)))}),Bangle.on("lcdPower",e=>{t.disableMinuteInterval(),e&&(t.enableMinuteInterval(),l.redrawAll())}),console.log(new Date,"f");