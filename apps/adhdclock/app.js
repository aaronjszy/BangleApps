"use strict";function n(e,t,i,s,n){var r,a,d;n=(n-1)/2,r=i-e,a=s-t,d=Math.sqrt(r*r+a*a),r=Math.round(r*n/d),a=Math.round(a*n/d),g.fillPoly([e+r,t-a,e-r,t+a,i-r,s+a,i+r,s-a])}function r(e){return("0"+e.toString(10)).substr(-2,1e3)}class d{constructor(i,s){if(s){var n=s.split(":");let e="12"==n[0]?"0":n[0],t=(e=s.endsWith("pm",void 0)?r(parseInt(e,10)+12):r(parseInt(e,10)),n[1]);2<t.length&&(t=t.substr(0,2));s="-"+r((new Date).getTimezoneOffset()/60)+"00";this.date=new Date(`${i}T${e}:${t}:00 GMT`+s)}else this.date=i?new Date(i):new Date}floorMinutes(){this.date.setMinutes(0,0,0)}addMinutes(e){this.date=new Date(this.date.getTime()+6e4*e)}valueOf(){return this.date}formattedTime(){var e=this.date.getHours()%12;return(e=0==e?12:e)+":"+r(this.date.getMinutes())}formattedDate(){return require("locale").month(this.date,1)+" "+this.date.getDate()}formattedDateTime(){return this.formattedDate()+" "+this.formattedTime()}unixTimestampMillis(){return this.date.getTime()}millisUntil(){var e=new Date;return this.date.getTime()-e.getTime()}secondsUntil(){var e=new Date;return(this.date.getTime()-e.getTime())/1e3+1}minutesUntil(){var e=new Date;return(this.date.getTime()-e.getTime())/1e3/60+1}timeRemainingAsString(){var e=this.secondsUntil(),t=e<0?"-":"",e=Math.abs(e),e=Math.floor(e/60),i=Math.floor(e/60),e=e%60;return 0==i?t+e:t+i+":"+r(e)}secondsRemainingAsString(){var e=this.secondsUntil(),e=Math.abs(e);return""+r(Math.floor(e%60))}equals(e){return this.date.getTime()==e.date.getTime()}}class t{constructor(e){this.tickHandler=e}scheduleNextMinuteTick(){setTimeout(()=>{this.tickHandler()},this.millisToNextMinute())}millisToNextMinute(){const e=new Date;return 6e4-(1e3*e.getSeconds()+e.getMilliseconds())}scheduleNextSecondTick(){setTimeout(()=>{this.tickHandler()},this.millisToNextSecond())}millisToNextSecond(){return 1e3-(new Date).getMilliseconds()}}var a;(v=a=a||{})[v.START=0]="START",v[v.END=1]="END";class h{constructor(e,t,i,s){this.alarmHandler=()=>{},this.id=e+"/"+(new Date).getTime().toString(10),this.name=e,this.description=t,this.startTime=i,this.endTime=s,this.skipped=!1,this.bangleCalendarEventId=void 0,this.trackedEventBoundary=a.END}static fromJSON(e){var t=new h(e.name,e.description,new d(e.startTime.date),new d(e.endTime.date));return t.id=e.id,t.skipped=e.skipped,t.bangleCalendarEventId=e.bangleCalendarEventId,t.trackedEventBoundary=e.trackedEventBoundary,t}setAlarmHandler(e){this.alarmHandler=e}update(e){if(e.bangleCalendarEventId!=this.bangleCalendarEventId)return!1;e.id=this.id,e.bangleCalendarEventId=this.bangleCalendarEventId,e.skipped=this.skipped,e.trackedEventBoundary=this.trackedEventBoundary,e.alarmHandler=this.alarmHandler;var t=JSON.stringify(e,void 0,void 0)!=JSON.stringify(this,void 0,void 0);return this.name=e.name,this.description=e.description,this.startTime=e.startTime,this.endTime=e.endTime,t}setBangleCalendarEventId(e){this.bangleCalendarEventId=e}toggleSkip(){return this.skipped=!this.skipped,this.skipped}toggleTrackedEventBoundary(){this.trackedEventBoundary=this.trackedEventBoundary==a.END?a.START:a.END}getTrackedEventBoundary(){return this.trackedEventBoundary}getTrackedEventDate(){return this.trackedEventBoundary==a.START?this.startTime:this.endTime}displayName(){return this.name.substr(0,14)}displayDescription(){return 0==this.description.length?"empty":50<this.displayDescription.length?this.description.substr(0,50)+"...":this.description}displayTimeRemaining(){return this.getTrackedEventDate().timeRemainingAsString()}displaySecondsRemaining(){return this.getTrackedEventDate().secondsRemainingAsString()}durationMinutes(){return(this.endTime.unixTimestampMillis()-this.startTime.unixTimestampMillis())/1e3/60}isExpired(){return!1}}class o{constructor(e){this.minutesPerSegment=30,this.maxSegmentCount=10,this.eventStart=e.startTime.date,this.eventEnd=e.endTime.date,this.segmentCountInt=this.segmentCount(e),this.maxMinutesInMeter=this.segmentCountInt*this.minutesPerSegment,this.meterStartTime=new Date(e.getTrackedEventDate().date.getTime()+6e4*-this.maxMinutesInMeter),this.meterEndTime=e.getTrackedEventDate().date,this.padding=5,this.height=22,this.meterTopOffsetPos=.73*g.getHeight(),this.maxMeterWidth=g.getWidth()-2*this.padding}segmentCount(e){var t=e.durationMinutes(),t=Math.ceil(t/this.minutesPerSegment),e=(t>this.maxSegmentCount&&(t=this.maxSegmentCount),Math.ceil(e.getTrackedEventDate().minutesUntil()/this.minutesPerSegment));return(e=e<=1?1:e)>this.maxSegmentCount&&(e=this.maxSegmentCount),Math.max(t,e)}draw(){for(var e,t=g.getColor(),i=(g.setColor("#00FF00"),this.drawMeterFill(this.meterStartTime,this.meterEndTime),g.setColor("#2c007d"),this.drawMeterFill(this.eventStart,this.eventEnd),g.setColor("#FF0000"),this.drawMeterFill(this.meterStartTime,new Date),this.meterStartTime.getTime()<this.eventStart.getTime()&&this.eventStart.getTime()<this.meterEndTime.getTime()&&(g.setColor("#00FF00"),e=this.dateToXPos(this.eventStart),g.fillPoly([e,this.meterTopOffsetPos,e,this.meterTopOffsetPos+this.height,e+this.height/2,this.meterTopOffsetPos+this.height/2]),g.drawLine(e,this.meterTopOffsetPos,e,this.meterTopOffsetPos+this.height)),g.setColor("#000000"),g.drawRect({x:this.padding,y:this.meterTopOffsetPos,h:this.height,w:this.maxMeterWidth}),g.drawRect({x:this.padding+1,y:this.meterTopOffsetPos+1,h:this.height-2,w:this.maxMeterWidth-2}),this.maxMeterWidth/this.segmentCountInt),s=1;s<=this.segmentCountInt;s++){var n=this.padding+i*s;g.drawLine(n,this.meterTopOffsetPos,n,this.meterTopOffsetPos+this.height),g.drawLine(n-1,this.meterTopOffsetPos,n-1,this.meterTopOffsetPos+this.height)}g.setColor(t)}drawMeterFill(e,t){e=this.dateToXPos(e),t=this.dateToXPos(t);e!=t&&g.fillRect(e,this.meterTopOffsetPos,t,this.meterTopOffsetPos+this.height)}dateToXPos(e){e=(e.getTime()-this.meterStartTime.getTime())/1e3/60/this.maxMinutesInMeter;return 1<(e=e<0?0:e)&&(e=1),(g.getWidth()-2*this.padding)*e+this.padding}}class s{constructor(e,t){this.clockFace=e,this.events=t}forceCalendarUpdate(){(NRF.getSecurityStatus().connected?(this.gbSend(JSON.stringify({t:"force_calendar_sync",ids:[]},void 0,void 0)),E.showAlert("Request sent to the phone")):E.showAlert("You are not connected")).then(()=>{this.clockFace.redrawAll()})}gbSend(e){Bluetooth.println(""),Bluetooth.println(JSON.stringify(e,void 0,void 0))}readCalendarDataAndUpdate(){this.events.removeExpiredEvents();var e=require("Storage").readJSON("android.calendar.json",!0);e?(this.events.updateFromCalendar(e),this.clockFace.redrawAll()):E.showAlert("No calendar data found.").then(()=>{E.showAlert().then(()=>{this.clockFace.redrawAll()})})}}require("Font7x11Numeric7Seg").add(Graphics);var l,m,i,c,e=new class{constructor(e){this.selectedEvent=0,this.events=e,this.refocusTimeout=void 0}save(){require("Storage").open("adhdclock.events","w").write(JSON.stringify(this,void 0,void 0))}restore(){var e=require("Storage").open("adhdclock.events","r");if(e){e=e.read(e.getLength());if(e){var t=JSON.parse(e);this.selectedEvent=t.selectedEvent,this.events=[];for(var i=0;i<t.events.length;i++)this.events[i]=h.fromJSON(t.events[i])}}return this}removeExpiredEvents(){var t=(new Date).getTime()-432e5;this.events=this.events.filter(e=>e.endTime.unixTimestampMillis()>t)}updateFromCalendar(e){for(var t=0,i=new Date,s=0;s<e.length;s++){var n=e[s],r=1e3*n.timestamp,a=1e3*(n.timestamp+n.durationInSeconds);a>i.getTime()+864e5||a<i.getTime()-864e5||n.title&&""!=n.title&&"calendar"==n.t&&!n.allDay&&86400!=n.durationInSeconds&&0==n.type&&((r=new h(n.title,n.description,new d(r),new d(a))).setBangleCalendarEventId(n.id),this.addEvent(r)&&t++)}return this.dedupEvents(),this.sortEvents(),this.selectUpcomingEvent(),t}addEvent(e){for(var t=0;t<this.events.length;t++){var i=this.events[t];if(i&&i.bangleCalendarEventId==e.bangleCalendarEventId)return i.update(e)}return this.events.push(e),!0}sortEvents(){this.events=this.events.sort((e,t)=>e.endTime.unixTimestampMillis()-t.endTime.unixTimestampMillis())}dedupEvents(){for(var e=0;e<this.events.length;e++){var t=this.events[e];if(t)for(var i=e+1;i<this.events.length;i++){var s=this.events[i];s&&t.name==s.name&&t.startTime.date.getTime()==s.startTime.date.getTime()&&t.endTime.date.getTime()==s.endTime.date.getTime()&&(this.events.splice(i,1),i--)}}}selectEvent(e){for(var t=0;t<this.events.length;t++)if(this.events[t]==e)return this.selectedEvent=t,this.getSelectedEvent();return this.getSelectedEvent()}getUpcomingEventIndex(){for(var e=Number.MAX_VALUE,t=this.events.length-1,i=0;i<this.events.length;i++){var s,n=this.events[i];n&&(s=n.endTime.secondsUntil(),!n.skipped&&0<=s&&s<e&&(e=n.endTime.secondsUntil(),t=i))}return t}selectUpcomingEvent(){return this.selectedEvent=this.getUpcomingEventIndex(),this.getSelectedEvent()}selectNextEvent(){return this.selectedEvent<this.events.length-1&&this.selectedEvent++,this.setRefocusTimeout(),this.getSelectedEvent()}selectPreviousEvent(){return 0<this.selectedEvent&&this.selectedEvent--,this.setRefocusTimeout(),this.getSelectedEvent()}getSelectedEvent(){return 0<this.events.length?this.events[this.selectedEvent]||new h("undefined","",new d,new d):new h("No events","",new d,new d)}setRefocusTimeout(){this.clearRefocusTimeout(),this.refocusTimeout=setTimeout(()=>{this.clearRefocusTimeout()},5e3)}clearRefocusTimeout(){this.refocusTimeout&&clearTimeout(this.refocusTimeout),this.refocusTimeout=void 0}hasEvents(){return 0<this.events.length}}([]).restore(),u=new class{constructor(e){this.eventsObj=e,this.clockInterval=new t(this.redrawAll)}redrawAll(){this.clockInterval.scheduleNextMinuteTick(),g.reset(),g.clearRect({x:0,y:24,x2:g.getHeight(),y2:g.getWidth()});var e=new d,t=this.eventsObj.getSelectedEvent(),i=(g.reset(),g.setFontAlign(0,1),g.setFont("Vector",20),g.drawString(t.displayName(),88,72,!1),g.setFont("Vector",40),t.displayTimeRemaining()),i=(g.drawString(i,88,132,!1),e.formattedTime()),e=t.getTrackedEventDate().formattedTime(),s=t.startTime.formattedTime()+"/";s!=e&&t.getTrackedEventBoundary()!=a.START||(s=""),require("FontDennis8").add(Graphics),g.setFont("Dennis8",2),g.setFontAlign(-1,1),g.drawString(i,5,g.getHeight()-2,!0),g.setFontAlign(1,1),g.drawString(s+e,g.getWidth()-5,g.getHeight()-2,!0),new o(t).draw(),t.skipped&&(n(0,25,g.getWidth(),g.getHeight(),3),n(g.getWidth(),25,0,g.getHeight(),3))}}(e),v=new d;v.addMinutes(60),v.floorMinutes(),setTimeout(function(){new s(u,e).readCalendarDataAndUpdate()},10),e.hasEvents()||e.addEvent(new h("next hour","",v,v)),e.selectUpcomingEvent(),Bangle.setUI("clock"),Bangle.loadWidgets(),Bangle.drawWidgets(),u.redrawAll(),l=u,m=e,setWatch(()=>{m.save(),Bangle.showLauncher()},BTN1,{repeat:!1,edge:"falling"}),Bangle.on("swipe",function(e,t){var i;-1==e&&0==t&&(m.selectNextEvent(),l.redrawAll()),1==e&&0==t&&(m.selectPreviousEvent(),l.redrawAll()),-1==t&&0==e&&(i=m.getSelectedEvent().toggleSkip(),l.redrawAll(),i&&setTimeout(()=>{m.selectUpcomingEvent(),l.redrawAll()},200)),1==t&&0==e&&new s(l,m).forceCalendarUpdate()}),c=!1,Bangle.on("touch",function(e,t){!t||c||(t.y>g.getHeight()-50?(m.getSelectedEvent().toggleTrackedEventBoundary(),l.redrawAll()):50<t.y&&(c=!0,setTimeout(()=>{E.showPrompt(m.getSelectedEvent().displayDescription(),{buttons:{Ok:1}}).then(()=>{c=!1,l.redrawAll()})},200)))}),i=global.GB,global.GB=function(e){"calendar"===e.t&&(console.log(e.id+": "+e.title),Terminal.println(e.id+": "+e.title)),i&&i(e)};